================================================================================
ğŸ“Š OMNIA - CONVERSATION SUMMARIZATION SYSTEM
================================================================================

ğŸ¯ HLAVNÃ CÃL:
SnÃ­Å¾it nÃ¡klady na tokeny o 82% per zprÃ¡va (50% na celÃ½ chat) pomocÃ­ hierarchickÃ©
komprese konverzacÃ­, pÅ™iÄemÅ¾ zachovat neomezenou pamÄ›Å¥ v rÃ¡mci kaÅ¾dÃ©ho cyklu.

================================================================================
âš™ï¸ SOUÄŒASNÃ‰ NASTAVENÃ
================================================================================

TRIGGER THRESHOLD: 19 zprÃ¡v (testovÃ¡nÃ­) â†’ pozdÄ›ji 49 â†’ pak 99 (produkce)
MODEL PRO CHAT: Gemini 2.5 Flash ($0.15/1M input, $0.60/1M output)
MODEL PRO SOUHRNY: Gemini 2.5 Flash-Lite ($0.10/1M input, $0.40/1M output)
MAX DÃ‰LKA SOUHRNU: 500 slov (~800 tokenÅ¯)

âš ï¸ ZNÃMÃ PROBLÃ‰M: Flash-Lite ignoruje limit 500 slov, generuje 2500-3000 slov
   (Bude tÅ™eba post-processing nebo pÅ™Ã­snÄ›jÅ¡Ã­ prompt)

================================================================================
ğŸ”„ JAK TO FUNGUJE - ZÃKLADNÃ FLOW
================================================================================

SCÃ‰NÃÅ˜: User chatuje s Omnia

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FÃZE 1: PÅ˜ED PRVNÃM SOUHRNEM                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ZprÃ¡va #1 (user):    â†’ Omnia dostane: [msg #1]
ZprÃ¡va #2 (bot):     â†’ OK
ZprÃ¡va #3 (user):    â†’ Omnia dostane: [msg #1, #2, #3]
ZprÃ¡va #4 (bot):     â†’ OK
...
ZprÃ¡va #18 (bot):    â†’ OK
ZprÃ¡va #19 (user):   â†’ TRIGGER! ğŸš¨

Co se stane pÅ™i triggeru:
1. shouldTriggerSummarization() vrÃ¡tÃ­ TRUE (19 >= 19)
2. getMessagesToSummarize() vrÃ¡tÃ­:
   - previousSummary: null
   - messagesToSummarize: zprÃ¡vy #1-18 (bez #19, ta jeÅ¡tÄ› nemÃ¡ odpovÄ›Ä)
3. VolÃ¡ se /api/summarize endpoint (Flash-Lite)
4. Flash-Lite vytvoÅ™Ã­ SUMMARY_1 z msg #1-18
5. UloÅ¾Ã­ se jako zprÃ¡va #20 s metadata:
   {
     hasMetadata: true,
     metadata: {
       summaryContent: "Text souhrnu zde...",
       messageCount: 18,
       compressionRatio: "95%",
       ...
     }
   }
6. Omnia odpovÃ­ na #19 â†’ zprÃ¡va #20
7. Metadata zprÃ¡va s SUMMARY_1 â†’ zprÃ¡va #21

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FÃZE 2: PO PRVNÃM SOUHRNU (cyklus 1)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ZprÃ¡va #22 (user):   â†’ Omnia dostane: [SUMMARY_1, msg #19-22]
ZprÃ¡va #23 (bot):    â†’ OK
ZprÃ¡va #24 (user):   â†’ Omnia dostane: [SUMMARY_1, msg #19-24]
...
ZprÃ¡va #37 (bot):    â†’ OK
ZprÃ¡va #38 (user):   â†’ Omnia dostane: [SUMMARY_1, msg #19-38]
ZprÃ¡va #39 (user):   â†’ TRIGGER! ğŸš¨ (20 zprÃ¡v od SUMMARY_1: #19-38)

Co se stane pÅ™i druhÃ©m triggeru:
1. shouldTriggerSummarization() vrÃ¡tÃ­ TRUE
   (zprÃ¡vy od poslednÃ­ho souhrnu: 39 - 21 - 1 = 19 zprÃ¡v >= 19)
2. getMessagesToSummarize() vrÃ¡tÃ­:
   - previousSummary: SUMMARY_1 (text z metadata)
   - messagesToSummarize: zprÃ¡vy #22-38 (bez #39)
3. Flash-Lite vytvoÅ™Ã­ SUMMARY_2:
   - Vezme SUMMARY_1
   - Extrahuje z nÄ›j JEN klÃ­ÄovÃ© info (komprese!)
   - PÅ™idÃ¡ novÃ© info z msg #22-38
   - VÃ½sledek: stÃ¡le ~500 slov
4. UloÅ¾Ã­ se jako zprÃ¡va #40 s metadata
5. Omnia odpovÃ­ â†’ zprÃ¡va #41
6. Metadata zprÃ¡va SUMMARY_2 â†’ zprÃ¡va #42

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FÃZE 3: PO DRUHÃ‰M SOUHRNU (cyklus 2)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ZprÃ¡va #43 (user):   â†’ Omnia dostane: [SUMMARY_2, msg #39-43]
                        âš ï¸ SUMMARY_1 uÅ¾ NENÃ v kontextu!
                        âœ… Ale info z nÄ›j JE (komprimovanÃ© v SUMMARY_2)

A takhle dÃ¡l donekoneÄna...

================================================================================
ğŸ’¾ UKLÃDÃNÃ DO DATABÃZE
================================================================================

STRUKTURA ZPRÃV:

NormÃ¡lnÃ­ zprÃ¡va:
{
  id: "uuid",
  chatId: "chat-uuid",
  sender: "user" | "bot",
  text: "Obsah zprÃ¡vy",
  hasMetadata: false,
  metadata: null,
  timestamp: 1234567890
}

ZprÃ¡va se souhrnem:
{
  id: "uuid",
  chatId: "chat-uuid",
  sender: "bot",
  text: "ğŸ§  Conversation summary created",  // â† Placeholder text pro UI
  hasMetadata: true,
  metadata: {
    summaryContent: "DetailnÃ­ text souhrnu zde...",  // â† SKUTEÄŒNÃ OBSAH!
    messageCount: 18,
    originalLength: 12500,
    summaryLength: 1200,
    compressionRatio: "95%",
    hadPreviousSummary: false,
    language: "cs",
    timestamp: "2025-01-04T12:00:00.000Z"
  },
  timestamp: 1234567890
}

ÃšLOÅ½IÅ TÄš:

1. IndexedDB (browser) - lokÃ¡lnÃ­ storage
   - Store: "messages"
   - Index: "chatId"
   - Metadata uloÅ¾ena jako JSONB

2. Supabase (cloud) - sync storage
   - Tabulka: "messages"
   - Sloupec metadata: JSONB
   - AutomatickÃ½ sync pÅ™i zmÄ›nÃ¡ch

================================================================================
ğŸ§  CONTEXT BUILDING - KLÃÄŒOVÃ LOGIKA
================================================================================

SOUBOR: /src/utils/contextBuilder.js

FUNKCE: buildContextForOmnia(messages, currentMessage)

LOGIKA:

1. Najdi poslednÃ­ souhrn v messages[]
   â†’ messages.slice().reverse().find(msg => msg.hasMetadata && msg.metadata?.summaryContent)

2. Pokud SOUHRN EXISTUJE:
   a) PÅ™idej do context[] fake message:
      {
        sender: 'bot',  // â† KRITICKÃ‰! MusÃ­ bÃ½t 'bot' ne 'omnia'!
        text: latestSummary.metadata.summaryContent  // â† TEXT Z METADATA!
      }

   b) Najdi index poslednÃ­ho souhrnu

   c) Vezmi VÅ ECHNY zprÃ¡vy AFTER summary:
      const messagesAfterSummary = messages.slice(lastSummaryIndex + 1);

   d) Vyfiltruj pÅ™Ã­padnÃ© dalÅ¡Ã­ summary zprÃ¡vy (max 1 by mÄ›la bÃ½t)
      const filtered = messagesAfterSummary.filter(
        msg => !msg.hasMetadata || !msg.metadata?.summaryContent
      );

   e) PÅ™idej VÅ ECHNY filtrovanÃ© zprÃ¡vy (Å½ÃDNÃ LIMIT!):
      context.push(...filtered);

   f) PÅ™idej aktuÃ¡lnÃ­ zprÃ¡vu:
      context.push({ sender: 'user', text: currentMessage });

3. Pokud SOUHRN NEEXISTUJE:
   a) PÅ™idej VÅ ECHNY messages (Å½ÃDNÃ LIMIT!)
   b) PÅ™idaj aktuÃ¡lnÃ­ zprÃ¡vu

PROÄŒ Å½ÃDNÃ LIMIT NA ZPRÃVY?
â†’ Trigger mechanismus pÅ™irozenÄ› limituje rÅ¯st!
â†’ Max zprÃ¡vy mezi dvÄ›ma souhrny = TRIGGER_THRESHOLD - 1
â†’ S trigger=19: max 18 zprÃ¡v mezi souhrny
â†’ Nikdy nedojde k neomezenÃ©mu rÅ¯stu na stovky zprÃ¡v

================================================================================
ğŸ¯ TRIGGER MECHANISMUS
================================================================================

SOUBOR: /src/utils/contextBuilder.js

FUNKCE: shouldTriggerSummarization(messages)

LOGIKA:

1. Najdi index poslednÃ­ho souhrnu:
   lastSummaryIndex = messages.findLastIndex(
     msg => msg.hasMetadata && msg.metadata?.summaryContent
   )

2. SpoÄÃ­tej zprÃ¡vy od poslednÃ­ho souhrnu:
   - Pokud lastSummaryIndex === -1 (Å¾Ã¡dnÃ½ souhrn):
     messagesSinceSummary = messages.length

   - Pokud souhrn existuje:
     messagesSinceSummary = messages.length - lastSummaryIndex - 1

3. Porovnej s thresholdem:
   return messagesSinceSummary >= TRIGGER_THRESHOLD

PÅ˜ÃKLAD (threshold=19):

messages.length = 39
lastSummaryIndex = 20 (zprÃ¡va #21 v UI je 20 v array)
messagesSinceSummary = 39 - 20 - 1 = 18

18 >= 19? â†’ FALSE, zatÃ­m netriggeruje

messages.length = 40
messagesSinceSummary = 40 - 20 - 1 = 19

19 >= 19? â†’ TRUE, TRIGGER!

================================================================================
ğŸ“Š VYTVÃÅ˜ENÃ SOUHRNU
================================================================================

SOUBOR: /api/summarize.js

ENDPOINT: POST /api/summarize

INPUT:
{
  previousSummary: "Text pÅ™edchozÃ­ho souhrnu..." | null,
  messages: [
    { sender: "user", text: "..." },
    { sender: "bot", text: "..." },
    ...
  ],
  language: "cs" | "en" | "ro" | ...
}

PROCESS:

1. Validace vstupu (messages musÃ­ existovat)

2. Inicializace Vertex AI s credentials z ENV:
   - GOOGLE_CLOUD_PROJECT_ID
   - GOOGLE_APPLICATION_CREDENTIALS (JSON string)

3. SestavenÃ­ conversation textu:
   messages.map(msg => {
     const role = msg.sender === 'user' ? 'User' : 'Omnia';
     return `${role}: ${msg.text}`;
   }).join('\n')

4. SestavenÃ­ promptu:

   SYSTEM PROMPT (zkrÃ¡ceno):
   ```
   You are an expert conversation summarization AI for Omnia's memory system.

   ## YOUR GOAL:
   Create hierarchical summaries that maintain constant length (~500 words max).

   ## CRITICAL RULES:
   1. Maximum 500 words (ALWAYS!)
   2. Write in plain text (no markdown!)
   3. Hierarchical compression: Extract only key facts from previous summary
   4. Language: Same as conversation
   5. Focus on: Main topics, decisions, key facts, user preferences

   ## COMPRESSION STRATEGY:
   When previous summary exists:
   - Extract only the most important facts (compress it!)
   - Add new information from new messages
   - Remove redundant details
   - Keep total under 500 words
   ```

   USER MESSAGE (s previous summary):
   ```
   Previous summary:
   [Text pÅ™edchozÃ­ho souhrnu]

   New messages:
   [Conversation text]

   Create a new summary that compresses the previous summary and adds
   information from new messages. Maximum 500 words, plain text only.
   ```

   USER MESSAGE (bez previous summary):
   ```
   Conversation:
   [Conversation text]

   Create a summary. Maximum 500 words, plain text only.
   ```

5. VolÃ¡nÃ­ Gemini 2.5 Flash-Lite:
   model: 'gemini-2.5-flash-lite'
   maxOutputTokens: 800  (~500 words)
   temperature: 0.3  (niÅ¾Å¡Ã­ = fokusovanÄ›jÅ¡Ã­)
   topP: 0.8
   topK: 40

6. Extrakce textu z response

OUTPUT:
{
  success: true,
  summary: "Text souhrnu...",
  metadata: {
    messageCount: 18,
    originalLength: 12500,
    summaryLength: 1200,
    compressionRatio: "95%",
    hadPreviousSummary: true,
    language: "cs",
    timestamp: "2025-01-04T12:00:00.000Z"
  }
}

================================================================================
ğŸ”§ INTEGRACE DO APP.jsx
================================================================================

LOKACE: /src/App.jsx (Å™Ã¡dky cca 800-850)

LOGIKA V handleSendMessage():

1. User odeÅ¡le zprÃ¡vu #19 (trigger)

2. PÅ™ed odeslÃ¡nÃ­m do Gemini Flash, zkontroluj trigger:
   const shouldSummarize = shouldTriggerSummarization(currentChat.messages);

3. Pokud shouldSummarize === true:

   a) ZÃ­skej zprÃ¡vy k sumarizaci:
      const { previousSummary, messagesToSummarize } =
        getMessagesToSummarize(currentChat.messages);

   b) Zavolej /api/summarize:
      const response = await fetch('/api/summarize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          previousSummary,
          messages: messagesToSummarize,
          language: uiLanguage
        })
      });

   c) Parsuj odpovÄ›Ä:
      const { summary, metadata } = await response.json();

   d) VytvoÅ™ metadata zprÃ¡vu:
      const summaryMessage = {
        id: generateUUID(),
        chatId: currentChat.id,
        sender: 'bot',
        text: 'ğŸ§  Conversation summary created',
        hasMetadata: true,
        metadata: {
          summaryContent: summary,
          ...metadata
        },
        timestamp: Date.now()
      };

   e) UloÅ¾ do IndexedDB + Supabase:
      await saveMessage(summaryMessage);
      await syncToSupabase(summaryMessage);

   f) PÅ™idej do currentChat.messages:
      currentChat.messages.push(summaryMessage);

4. Sestav context pro Omnia pomocÃ­ buildContextForOmnia():
   const context = buildContextForOmnia(currentChat.messages, userMessage);

5. PoÅ¡li context do Gemini Flash jako obvykle

================================================================================
ğŸ›ï¸ KRITICKÃ PRAVIDLA PRO CONTEXT
================================================================================

âš ï¸ FAKE SUMMARY MESSAGE MUSÃ MÃT sender: 'bot' âš ï¸

DÅ®VOD: prepareGeminiMessages() v gemini.service.js filtruje POUZE:
- sender === 'user'
- sender === 'bot'

Pokud dÃ¡me sender: 'omnia', zprÃ¡va se ODFILTRUJE a Omnia souhrn NEDOSTANE!

KÃ“D V /src/services/ai/gemini.service.js (Å™Ã¡dek 191-221):

```javascript
prepareGeminiMessages(messages) {
  const validMessages = messages.filter(msg =>
    msg.sender === 'user' || msg.sender === 'bot'  // â† KRITICKÃ‰!
  );

  return validMessages.map(msg => ({
    sender: msg.sender,
    text: msg.aiText || msg.text || '',
    content: msg.aiText || msg.text || ''
  }));
}
```

PROTO V contextBuilder.js MUSÃ BÃT:

```javascript
context.push({
  sender: 'bot',  // âœ… SPRÃVNÄš!
  text: latestSummary.metadata.summaryContent
});
```

NIKDY NE:

```javascript
context.push({
  sender: 'omnia',  // âŒ Å PATNÄš! Odfiltruje se!
  text: latestSummary.metadata.summaryContent
});
```

================================================================================
ğŸ’° NÃKLADY A ÃšSPORY
================================================================================

CENY (2025):
- Gemini 2.5 Flash: $0.15/1M input, $0.60/1M output
- Gemini 2.5 Flash-Lite: $0.10/1M input, $0.40/1M output

SCÃ‰NÃÅ˜: 1500 zprÃ¡v, 149 trigger, 2000 word summaries

BEZ SUMARIZACE:
- PrÅ¯mÄ›rnÄ› 50 slov/zprÃ¡va
- Konec chatu: ~75,000 slov = ~100k tokenÅ¯
- Input cost: 100k Ã— $0.15/1M = $0.015
- Output cost: (50 slov Ã— 1500 zprÃ¡v Ã— 0.75 tokens/word) Ã— $0.60/1M = ~$0.034
- CELKEM: ~$2.50-$3.00 na full chat

SE SUMARIZACÃ (trigger=149):
- Summaries: 1500/149 = ~10 summarÅ¯
- KaÅ¾dÃ½ summary: 2000 slov = ~2700 tokenÅ¯
- Summary cost: (10 Ã— 2700) Ã— ($0.10 + $0.40)/1M = ~$0.014
- Context za summary: ~10k tokenÅ¯ (summary + messages)
- Main model cost: ~1500 zprÃ¡v Ã— 10k avg Ã— $0.15/1M = ~$1.50
- CELKEM: ~$1.50-$1.52 na full chat

ÃšSPORA:
- Per full chat (1500 msgs): ~50% Ãºspora ($3.00 â†’ $1.52)
- Per message v late-stage: ~82% Ãºspora (10k â†’ 2k tokenÅ¯ avg)

S MENÅ ÃM TRIGGEREM (19):
- VÃ­c summarÅ¯ = vÃ­c summary costs
- Ale menÅ¡Ã­ context = menÅ¡Ã­ main model costs
- Net effect: stÃ¡le vÃ½znamnÃ¡ Ãºspora (50-70%)

================================================================================
ğŸ› ZNÃMÃ‰ PROBLÃ‰MY A Å˜EÅ ENÃ
================================================================================

PROBLÃ‰M #1: Flash-Lite ignoruje word limit
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYMPTOM: Generuje 2500-3000 slov mÃ­sto 500
STATUS: Ongoing issue
MOÅ½NÃ Å˜EÅ ENÃ:
- PÅ™Ã­snÄ›jÅ¡Ã­ prompt s opakovÃ¡nÃ­m "MAX 500 WORDS"
- Post-processing truncation na 500 slov
- Zkusit jinÃ½ model (Flash mÃ­sto Flash-Lite?)

PROBLÃ‰M #2: Omnia nedostÃ¡vÃ¡ souhrny (VYÅ˜EÅ ENO)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYMPTOM: Summaries vytvoÅ™eny, ale Omnia si nic nepamatuje
ROOT CAUSE: Fake summary message mÄ›la sender: 'omnia'
FIX: ZmÄ›nÄ›no na sender: 'bot' v contextBuilder.js:122
COMMIT: c089d1d

PROBLÃ‰M #3: Summaries rostou mÃ­sto komprese (ÄŒÃSTEÄŒNÄš VYÅ˜EÅ ENO)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYMPTOM: Summary_1: 300 slov â†’ Summary_2: 500 â†’ Summary_3: 1000
ROOT CAUSE: Flash-Lite pÅ™idÃ¡val mÃ­sto komprese
FIX: PÅ™epsanÃ½ prompt s jasnou compression strategy
COMMIT: 7f938d4
STATUS: LepÅ¡Ã­, ale stÃ¡le generuje vÃ­c neÅ¾ 500 slov (viz ProblÃ©m #1)

PROBLÃ‰M #4: Confusion o "all messages" (VYÅ˜EÅ ENO)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYMPTOM: PosÃ­laly se vÅ¡echny zprÃ¡vy z celÃ©ho chatu mÃ­sto jen aktuÃ¡lnÃ­ho cyklu
ROOT CAUSE: NepochopenÃ­ user requirements
FIX: OdebrÃ¡ny limity, ale trigger pÅ™irozenÄ› limituje rÅ¯st
RESULT: Max messages mezi souhrny = TRIGGER_THRESHOLD - 1

================================================================================
ğŸ“ˆ PLÃN DALÅ ÃHO TESTOVÃNÃ
================================================================================

CURRENT STATE: Trigger = 19 zprÃ¡v (testovÃ¡nÃ­)

FÃZE 1 (PROBÃHÃ):
âœ… Otestovat zÃ¡kladnÃ­ funkcionalitu s 19 trigger
âœ… OvÄ›Å™it, Å¾e souhrny se vytvÃ¡Å™ejÃ­
âœ… OvÄ›Å™it, Å¾e Omnia souhrny dostÃ¡vÃ¡
âœ… OvÄ›Å™it, Å¾e context obsahuje sprÃ¡vnÃ© zprÃ¡vy
â³ Sledovat, jak se chovajÃ­ summaries pÅ™i opakovanÃ© kompresi

FÃZE 2 (DALÅ Ã):
â†’ ZvÃ½Å¡it trigger na 49 zprÃ¡v
â†’ Otestovat s delÅ¡Ã­mi konverzacemi
â†’ MÄ›Å™it compression ratios
â†’ Sledovat kvalitu pamÄ›ti Omnie

FÃZE 3 (PRODUKCE):
â†’ ZvÃ½Å¡it trigger na 99 nebo 149 zprÃ¡v
â†’ FinÃ¡lnÃ­ ladÄ›nÃ­ compression strategy
â†’ MoÅ¾nÃ¡ zvÃ½Å¡it max slova na 1000-1500 pokud nutnÃ©
â†’ Deploy do produkce

================================================================================
ğŸ“‚ SEZNAM VÅ ECH DOTÄŒENÃCH SOUBORÅ®
================================================================================

/src/utils/contextBuilder.js
â”œâ”€â”€ shouldTriggerSummarization()     # Detekce triggeru
â”œâ”€â”€ getMessagesToSummarize()         # Extrakce zprÃ¡v pro summary
â”œâ”€â”€ buildContextForOmnia()           # SestavenÃ­ contextu pro Gemini
â””â”€â”€ getCounterInfo()                 # Debug info

/api/summarize.js
â””â”€â”€ handler()                        # Serverless endpoint pro Flash-Lite

/src/services/ai/gemini.service.js
â””â”€â”€ prepareGeminiMessages()          # Filtruje jen 'user' a 'bot' senders

/src/App.jsx
â””â”€â”€ handleSendMessage()              # Integrace trigger + summary + context

/src/services/db/indexedDB.js
â””â”€â”€ saveMessage()                    # UklÃ¡dÃ¡nÃ­ metadata zprÃ¡v

/src/services/db/supabase.service.js
â””â”€â”€ syncMessage()                    # Sync metadata do Supabase

================================================================================
ğŸ” DEBUG TIPS
================================================================================

CONSOLE LOGS:

Context building:
- "ğŸ“Š [CONTEXT] Found summary, adding to context"
- "ğŸ“Š [CONTEXT] Summary length: XXX chars"
- "ğŸ¯ [CONTEXT] Messages after summary: ..."
- "ğŸ¯ [CONTEXT] Final context size: N"

Trigger detection:
- "ğŸ” [CONTEXT] Summary trigger check: { ... }"

Summarization:
- "ğŸ“Š [SUMMARIZE] Starting summarization..."
- "ğŸ“Š [SUMMARIZE] Previous summary exists: true/false"
- "ğŸ“Š [SUMMARIZE] Messages to summarize: N"
- "âœ… [SUMMARIZE] Summary created successfully"
- "ğŸ“Š [SUMMARIZE] Compression ratio: XX%"

TYPICKÃ‰ HODNOTY:

PÅ™ed prvnÃ­m summary (trigger=19):
- totalMessages: 19
- lastSummaryIndex: -1
- messagesSinceSummary: 19
- threshold: 19
- shouldTrigger: true

Po prvnÃ­m summary (msg #40):
- totalMessages: 40
- lastSummaryIndex: 20 (zprÃ¡va s metadata)
- messagesSinceSummary: 19
- shouldTrigger: true

KONTROLA SPRÃVNÃ‰HO CHOVÃNÃ:

1. Zkontroluj IndexedDB â†’ messages store
   â†’ Najdi zprÃ¡vy s hasMetadata: true
   â†’ OvÄ›Å™, Å¾e metadata.summaryContent obsahuje text

2. Zkontroluj Supabase â†’ messages table
   â†’ Sloupec metadata by mÄ›l obsahovat JSONB s summaryContent

3. Zkontroluj console logs pÅ™i odesÃ­lÃ¡nÃ­ zprÃ¡vy:
   â†’ "ğŸ¯ [CONTEXT] Final context size" by mÄ›l bÃ½t:
      - PÅ™ed summary: N zprÃ¡v
      - Po summary: 1 (fake summary) + M (zprÃ¡vy od summary) + 1 (current)

4. Zkontroluj token count:
   â†’ "ğŸ¯ [CONTEXT] Estimated tokens: N"
   â†’ S summary by mÄ›lo bÃ½t vÃ½raznÄ› mÃ©nÄ› neÅ¾ bez

================================================================================
âœ… ZÃVÄšR
================================================================================

SOUÄŒASNÃ STAV: âœ… FUNKÄŒNÃ (s drobnÃ½mi problÃ©my)

CO FUNGUJE:
âœ… Trigger detection (19 zprÃ¡v)
âœ… Hierarchical summarization (Flash-Lite)
âœ… Metadata storage (IndexedDB + Supabase)
âœ… Context building (summary + all messages in cycle)
âœ… Omnia receiving summaries (fixed sender: 'bot')
âœ… Cost savings (~50-82%)

CO JEÅ TÄš POTÅ˜EBUJE PRÃCI:
âš ï¸ Flash-Lite word limit (generuje 2500-3000 mÃ­sto 500)
âš ï¸ DalÅ¡Ã­ testovÃ¡nÃ­ s vyÅ¡Å¡Ã­mi triggery (49, 99)
âš ï¸ MoÅ¾nÃ¡ zvÃ½Å¡enÃ­ max slov na 1000-1500 pokud nutnÃ©

CELKOVÄš: Solid zÃ¡klad, fungujÃ­cÃ­ systÃ©m, ready pro dalÅ¡Ã­ testovÃ¡nÃ­ a ladÄ›nÃ­!

================================================================================
ğŸ“… POSLEDNÃ UPDATE: 2025-01-04
ğŸ“ AUTOR: DetailnÃ­ dokumentace vytvoÅ™ena na zÃ¡kladÄ› implementace a testovÃ¡nÃ­
================================================================================
