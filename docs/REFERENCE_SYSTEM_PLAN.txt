# ğŸ¯ REFERENCE SYSTEM - KOMPLETNÃ IMPLEMENTAÄŒNÃ PLÃN

**Datum:** 2025-10-08
**VÃ½chozÃ­ commit:** 1a3a4ee (ÄistÃ½ stav s Flash Image multi-generation)
**CÃ­l:** UmoÅ¾nit Omnii pÅ™irozenÄ› pouÅ¾Ã­vat pÅ™edchozÃ­ vÃ½stupy (obrazy, dokumenty, PDFy, zdroje)

---

## ğŸ“Š AKTUÃLNÃ STAV (commit 1a3a4ee)

### âœ… Co JIÅ½ FUNGUJE:

1. **App.jsx - Metadata se uklÃ¡dajÃ­ do zprÃ¡v:**
   ```javascript
   // Bot zprÃ¡vy obsahujÃ­:
   {
     sender: 'bot',
     text: '...',
     sources: [],        // âœ… z Google Search
     images: [...],      // âœ… z generovÃ¡nÃ­ obrÃ¡zkÅ¯
     pdf: {...}          // âœ… z PDF generovÃ¡nÃ­
   }

   // User zprÃ¡vy obsahujÃ­:
   {
     sender: 'user',
     text: '...',
     attachments: [...]  // âœ… nahranÃ© dokumenty
   }
   ```

2. **Backend - Flash Image multi-image generation:**
   - Sequential calls pro 1-3 obrÃ¡zky
   - Funguje v produkci

### âŒ Co NEFUNGUJE - REFERENCE AWARENESS:

**Problem #1: Frontend neposÃ­lÃ¡ metadata na backend**

`/src/services/ai/gemini.service.js` - `prepareGeminiMessages()` (Å™Ã¡dky 198-210):
```javascript
// AKTUÃLNÃ STAV (Å PATNÄš):
let geminiMessages = validMessages.map(msg => {
  const messageText = msg.aiText || msg.text || '';
  return {
    sender: msg.sender,
    text: messageText,
    content: messageText
    // âŒ Å½Ã¡dnÃ© images
    // âŒ Å½Ã¡dnÃ© attachments/documents
    // âŒ Å½Ã¡dnÃ© pdf
    // âŒ Å½Ã¡dnÃ© sources
  };
});
```

**Problem #2: Backend neextraktuje references**

`/api/gemini.js` - NedÄ›lÃ¡ nic s metadata (pokud by je dostal):
- Neextraktuje image URLs z poslednÃ­ch zprÃ¡v
- Neextraktuje uploaded documents
- Neextraktuje PDFs
- Neextraktuje Google sources

**Problem #3: Backend nevklÃ¡dÃ¡ references do system promptu**

`/api/gemini.js` - System prompt neobsahuje info o dostupnÃ½ch assets:
- Omnia nevÃ­ jakÃ© obrÃ¡zky jsou v chatu
- Omnia nevÃ­ jakÃ© dokumenty user nahrÃ¡l
- Omnia nevÃ­ jakÃ© PDFy vytvoÅ™ila
- Omnia nevÃ­ jakÃ© zdroje naÅ¡la

**DÅ¯sledek:**
> User: "uprav ten poslednÃ­ obrÃ¡zek"
> Omnia: "PotÅ™ebuji URL obrÃ¡zku"
> âŒ MÄ›la by vÄ›dÄ›t automaticky!

---

## ğŸ—ï¸ ARCHITEKTURA Å˜EÅ ENÃ

### Koncept - OddÄ›lenÃ­ konverzace od digitÃ¡lnÃ­ch assetÅ¯:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KONVERZACE (sumarizovatelnÃ¡)                               â”‚
â”‚  - User prompty, Omnia odpovÄ›di                             â”‚
â”‚  - Komprimuje se kaÅ¾dÃ½ch 99 zprÃ¡v                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DIGITÃLNÃ ASSETY (explicitnÃ­ reference)                    â”‚
â”‚  - ObrÃ¡zky (URLs z generovÃ¡nÃ­)                              â”‚
â”‚  - Dokumenty (URLs z nahrÃ¡nÃ­)                               â”‚
â”‚  - PDFy (URLs z generovÃ¡nÃ­)                                 â”‚
â”‚  - Zdroje (titulky + domÃ©ny z Google Search)               â”‚
â”‚  â†’ ExtraktujÃ­ se z poslednÃ­ch 20 zprÃ¡v                      â”‚
â”‚  â†’ VklÃ¡dajÃ­ se do system promptu jako dostupnÃ© reference    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Princip:
1. Metadata se uklÃ¡dajÃ­ do zprÃ¡v (uÅ¾ funguje âœ…)
2. Frontend posÃ­lÃ¡ metadata na backend (TODO ğŸ†•)
3. Backend extraktuje references z poslednÃ­ch zprÃ¡v (TODO ğŸ†•)
4. Backend vklÃ¡dÃ¡ references do system promptu (TODO ğŸ†•)
5. Omnia vidÃ­ dostupnÃ© assety a mÅ¯Å¾e je pouÅ¾Ã­vat (TODO ğŸ†•)

---

## ğŸ”§ IMPLEMENTACE - 3 KROKY

### KROK 1: Frontend - PosÃ­lat metadata na backend

**Soubor:** `/src/services/ai/gemini.service.js`
**Å˜Ã¡dky:** 198-210
**Funkce:** `prepareGeminiMessages(messages)`

**ZMÄšNA:**

```javascript
let geminiMessages = validMessages.map(msg => {
  // Use aiText for AI processing if available, otherwise fall back to text
  const messageText = msg.aiText || msg.text || '';
  const message = {
    sender: msg.sender,
    text: messageText,
    content: messageText
  };

  // ğŸ”— Include ALL metadata for reference system
  if (msg.images && Array.isArray(msg.images) && msg.images.length > 0) {
    message.images = msg.images;
  }

  if (msg.attachments && Array.isArray(msg.attachments) && msg.attachments.length > 0) {
    message.documents = msg.attachments; // Rename attachments â†’ documents for backend clarity
  }

  if (msg.pdf) {
    message.pdf = msg.pdf;
  }

  if (msg.sources && Array.isArray(msg.sources) && msg.sources.length > 0) {
    message.sources = msg.sources;
  }

  return message;
});
```

**Co se stane:**
- Frontend bude posÃ­lat na backend nejen `text` a `sender`, ale i vÅ¡echna metadata
- Backend dostane kompletnÃ­ info o obrazech, dokumentech, PDFech, zdrojÃ­ch

---

### KROK 2: Backend - Extraktovat references z poslednÃ­ch zprÃ¡v

**Soubor:** `/api/gemini.js`
**UmÃ­stÄ›nÃ­:** PÅ™ed konstrukci `finalSystemInstruction` (cca Å™Ã¡dek 106-140)

**KÃ“D:**

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”— REFERENCE EXTRACTION - Extract assets from last 20 messages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console.log('ğŸ”— [REFERENCES] Extracting from last 20 messages...');

const availableImages = [];
const availableDocuments = [];
const availablePdfs = [];
const recentSources = [];

// Process last 20 messages (recent context window)
messages.slice(-20).forEach(msg => {
  // ğŸ“¸ IMAGES - from bot responses (generated images)
  if (msg.sender === 'bot' && msg.images && Array.isArray(msg.images)) {
    msg.images.forEach(img => {
      // Only include images with valid Supabase URLs
      if (img.storageUrl && img.storageUrl.startsWith('https://')) {
        availableImages.push({
          url: img.storageUrl,
          timestamp: img.timestamp || msg.timestamp
        });
      }
    });
  }

  // ğŸ“„ DOCUMENTS - from user uploads
  if (msg.sender === 'user' && msg.documents && Array.isArray(msg.documents)) {
    msg.documents.forEach(doc => {
      // Documents use GCS URLs (gs://)
      if (doc.storageUrl && doc.storageUrl.startsWith('gs://')) {
        availableDocuments.push({
          url: doc.storageUrl,
          name: doc.name || 'Document',
          type: doc.type || 'unknown',
          timestamp: doc.timestamp || msg.timestamp
        });
      }
    });
  }

  // ğŸ“‹ PDFs - from bot responses (generated PDFs)
  if (msg.sender === 'bot' && msg.pdf) {
    availablePdfs.push({
      title: msg.pdf.title || 'PDF Document',
      url: msg.pdf.storageUrl || null,
      timestamp: msg.pdf.timestamp || msg.timestamp
    });
  }

  // ğŸ” GOOGLE SOURCES - from bot responses (web search)
  if (msg.sender === 'bot' && msg.sources && Array.isArray(msg.sources)) {
    msg.sources.forEach(src => {
      if (src.title && src.url) {
        recentSources.push({
          title: src.title,
          url: src.url,
          domain: src.domain || 'unknown'
        });
      }
    });
  }
});

// Limit sizes (prevent prompt bloat)
const images = availableImages.slice(-10);      // Last 10 images
const documents = availableDocuments.slice(-5); // Last 5 documents
const pdfs = availablePdfs.slice(-3);          // Last 3 PDFs
const sources = recentSources.slice(-8);       // Last 8 sources

console.log('ğŸ”— [REFERENCES] Extracted:', {
  images: images.length,
  documents: documents.length,
  pdfs: pdfs.length,
  sources: sources.length
});
```

**Co se stane:**
- Backend projde poslednÃ­ch 20 zprÃ¡v
- Extraktuje vÅ¡echny obrÃ¡zky, dokumenty, PDFy, zdroje
- OmezÃ­ poÄty (10/5/3/8) aby system prompt nebyl moc dlouhÃ½

---

### KROK 3: Backend - Inject references do system promptu

**Soubor:** `/api/gemini.js`
**UmÃ­stÄ›nÃ­:** Na konec `finalSystemInstruction` (pÅ™ed odeslÃ¡nÃ­m na API)

**KÃ“D:**

```javascript
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”— INJECT REFERENCES into system prompt
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ“¸ AVAILABLE IMAGES
if (images.length > 0) {
  finalSystemInstruction += '\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  finalSystemInstruction += 'ğŸ“¸ **IMAGES IN THIS CHAT:**\n\n';

  images.forEach((img, i) => {
    finalSystemInstruction += `[${i + 1}] ${img.url}\n`;
  });

  finalSystemInstruction += '\nğŸ’¡ **Usage:**\n';
  finalSystemInstruction += '- When user says "edit this image" or "edit the last image" â†’ use edit_image(prompt, url)\n';
  finalSystemInstruction += '- When user says "combine these images" â†’ use combine_images(prompt, [url1, url2])\n';
  finalSystemInstruction += '- You can reference images by number [1], [2], etc.\n';
}

// ğŸ“„ AVAILABLE DOCUMENTS
if (documents.length > 0) {
  finalSystemInstruction += '\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  finalSystemInstruction += 'ğŸ“„ **UPLOADED DOCUMENTS:**\n\n';

  documents.forEach((doc, i) => {
    finalSystemInstruction += `[${i + 1}] ${doc.name} (${doc.type})\n`;
    finalSystemInstruction += `    ${doc.url}\n`;
  });

  finalSystemInstruction += '\nğŸ’¡ **Usage:**\n';
  finalSystemInstruction += '- When user says "that document" or "the PDF I uploaded" â†’ reference these\n';
  finalSystemInstruction += '- User already uploaded them, you have analyzed them\n';
}

// ğŸ“‹ AVAILABLE PDFs
if (pdfs.length > 0) {
  finalSystemInstruction += '\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  finalSystemInstruction += 'ğŸ“‹ **GENERATED PDFs:**\n\n';

  pdfs.forEach((pdf, i) => {
    finalSystemInstruction += `[${i + 1}] "${pdf.title}"`;
    if (pdf.url) {
      finalSystemInstruction += ` - ${pdf.url}`;
    }
    finalSystemInstruction += '\n';
  });

  finalSystemInstruction += '\nğŸ’¡ **Usage:**\n';
  finalSystemInstruction += '- When user says "create another PDF like the last one" â†’ reference structure\n';
  finalSystemInstruction += '- You created these PDFs in this conversation\n';
}

// ğŸ” RECENT GOOGLE SOURCES
if (sources.length > 0) {
  finalSystemInstruction += '\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  finalSystemInstruction += 'ğŸ” **RECENT SEARCH SOURCES:**\n\n';

  sources.forEach((src, i) => {
    finalSystemInstruction += `[${i + 1}] ${src.title}\n`;
    finalSystemInstruction += `    ${src.domain} - ${src.url}\n`;
  });

  finalSystemInstruction += '\nğŸ’¡ **Usage:**\n';
  finalSystemInstruction += '- When user says "those sources" or "that article" â†’ reference these\n';
  finalSystemInstruction += '- You found these via Google Search in this conversation\n';
}

console.log('ğŸ”— [REFERENCES] Injected into system prompt');
```

**Co se stane:**
- System prompt bude obsahovat seznam vÅ¡ech dostupnÃ½ch assetÅ¯
- Omnia uvidÃ­ obrÃ¡zky, dokumenty, PDFy, zdroje s URLs
- MÅ¯Å¾e je pÅ™irozenÄ› pouÅ¾Ã­vat bez nutnosti user zadÃ¡vat URLs

---

## âœ… TESTOVACÃ SCÃ‰NÃÅ˜E

Po implementaci otestovat nÃ¡sledujÃ­cÃ­ pÅ™Ã­pady:

### Test 1: Auto-detekce obrÃ¡zkÅ¯
```
User: "vygeneruj obrÃ¡zek psa"
Omnia: [generuje obrÃ¡zek]
User: "udÄ›lej ho ÄernobÃ­lÃ½"
Omnia: âœ… PouÅ¾ije edit_image() s URL z pÅ™edchozÃ­ho obrÃ¡zku (bez nutnosti user zadÃ¡vat URL)
```

### Test 2: Kombinace vÃ­ce obrÃ¡zkÅ¯
```
User: "vygeneruj obrÃ¡zek auta"
Omnia: [generuje obrÃ¡zek]
User: "vygeneruj obrÃ¡zek silnice"
Omnia: [generuje obrÃ¡zek]
User: "dej to auto na tu silnici"
Omnia: âœ… PouÅ¾ije combine_images() s obÄ›ma URLs automaticky
```

### Test 3: Reference na dokumenty
```
User: [nahraje PDF dokument]
Omnia: [analyzuje dokument]
User: "co bylo v tom dokumentu o financÃ­ch?"
Omnia: âœ… OdpovÃ­ s vÄ›domÃ­m Å¾e dokument existuje a byl analyzovÃ¡n
```

### Test 4: Reference na PDFs
```
User: "vytvoÅ™ mi PDF report o AI"
Omnia: [vytvoÅ™Ã­ PDF]
User: "udÄ›lej dalÅ¡Ã­ podobnÃ½, ale o blockchain"
Omnia: âœ… PouÅ¾ije podobnou strukturu jako pÅ™edchozÃ­ PDF
```

### Test 5: Reference na Google zdroje
```
User: "najdi mi info o Gemini 2.0"
Omnia: [hledÃ¡ na Google, najde zdroje]
User: "kterÃ½ z tÄ›ch zdrojÅ¯ je od Googlu?"
Omnia: âœ… OdpovÃ­ s vÄ›domÃ­m kterÃ© zdroje naÅ¡la
```

### Test 6: Kontinuita ("make another")
```
User: "vygeneruj obrÃ¡zek lesa"
Omnia: [generuje]
User: "jeÅ¡tÄ› jeden"
Omnia: âœ… Vygeneruje dalÅ¡Ã­ obrÃ¡zek lesa (rozumÃ­ kontextu)
```

---

## ğŸ“ SOUBORY K ÃšPRAVÄš

### 1. Frontend - Metadata sending
- **Soubor:** `/src/services/ai/gemini.service.js`
- **Funkce:** `prepareGeminiMessages(messages)`
- **Å˜Ã¡dky:** 198-210
- **ZmÄ›ny:** ~20 Å™Ã¡dkÅ¯

### 2. Backend - Reference extraction
- **Soubor:** `/api/gemini.js`
- **UmÃ­stÄ›nÃ­:** PÅ™ed `finalSystemInstruction` (cca Å™Ã¡dek 106)
- **ZmÄ›ny:** ~60 Å™Ã¡dkÅ¯ (extraction logic)

### 3. Backend - Prompt injection
- **Soubor:** `/api/gemini.js`
- **UmÃ­stÄ›nÃ­:** Na konec `finalSystemInstruction` (cca Å™Ã¡dek 140+)
- **ZmÄ›ny:** ~50 Å™Ã¡dkÅ¯ (injection logic)

---

## â±ï¸ ODHAD IMPLEMENTACE

- **Krok 1 (Frontend):** 10 minut
- **Krok 2 (Backend extraction):** 20 minut
- **Krok 3 (Backend injection):** 15 minut
- **TestovÃ¡nÃ­:** 30 minut
- **Debugging + fixes:** 30 minut

**Celkem:** ~1.5-2 hodiny ÄistÃ© prÃ¡ce

---

## ğŸš€ LONG-TERM: Cloud Run + Live API

Po ÃºspÄ›Å¡nÃ© implementaci Reference System (Phase 1), nÃ¡sleduje:

### Phase 2: Cloud Run + Live API Migration

**ProÄ:**
- Live API podporuje multiple tools nativnÄ› (search + functions souÄasnÄ›)
- WebSocket bidirectional streaming (lepÅ¡Ã­ UX)
- Google Cloud kredity (23k KÄ + $1000/rok) â†’ Cloud Run je zadarmo

**Jak:**
1. VytvoÅ™it `omnia-backend` repository
2. Implementovat WebSocket server (Node.js + Express)
3. Integrovat Live API mÃ­sto Standard API
4. Deploy na Cloud Run (GitHub auto-deploy)
5. Update frontend pro WebSocket komunikaci

**Odhad:** 3-5 dnÃ­ prÃ¡ce

**Benefit:**
- Å½Ã¡dnÃ© workaroundy s dynamic tool selection
- NativnÃ­ podpora mix search + functions
- ProfesionÃ¡lnÃ­ architektura (separace backend/frontend)

---

## ğŸ“‹ POZNÃMKY

### ProÄ 20 zprÃ¡v pro extraction?
- RozumnÃ¡ velikost context window
- ZachytÃ­ poslednÃ­ konverzaci
- NepÅ™etÄ›Å¾uje system prompt

### ProÄ limity (10/5/3/8)?
- OmezujÃ­ velikost system promptu
- NejnovÄ›jÅ¡Ã­ assety jsou nejrelevantnÄ›jÅ¡Ã­
- ZachovÃ¡vÃ¡ performance

### ProÄ images z bot a documents z user?
- Images generuje Omnia â†’ bot messages
- Documents uploaduje user â†’ user messages
- PDFs generuje Omnia â†’ bot messages
- Sources hledÃ¡ Omnia â†’ bot messages

### Co s gs:// URLs?
- Documents pouÅ¾Ã­vajÃ­ Google Cloud Storage
- Backend (Cloud Functions) mÃ¡ pÅ™Ã­stup k GCS
- Omnia mÅ¯Å¾e ÄÃ­st gs:// URLs pÅ™Ã­mo

### Co s https:// URLs?
- Images jsou na Supabase (public URLs)
- Omnia mÅ¯Å¾e ÄÃ­st/editovat pÅ™Ã­mo
- Å½Ã¡dnÃ¡ autentizace potÅ™eba

---

## ğŸ¯ SUCCESS CRITERIA

Reference System je ÃºspÄ›Å¡nÃ½ kdyÅ¾:

âœ… User mÅ¯Å¾e Å™Ã­ct "uprav ten poslednÃ­ obrÃ¡zek" bez URL
âœ… User mÅ¯Å¾e Å™Ã­ct "kombinuj ty 3 obrÃ¡zky" bez URLs
âœ… User mÅ¯Å¾e Å™Ã­ct "to co jsi naÅ¡la na Google" a Omnia vÃ­
âœ… User mÅ¯Å¾e Å™Ã­ct "udÄ›lej jeÅ¡tÄ› jeden PDF jako pÅ™edtÃ­m"
âœ… System prompt obsahuje references automaticky
âœ… Omnia neÅ™Ã­kÃ¡ "PotÅ™ebuji URL obrÃ¡zku"
âœ… Kontinuita konverzace funguje pÅ™irozenÄ›

---

**Status:** â³ PÅ™ipraveno k implementaci
**Next:** Implementovat po vyÅ™eÅ¡enÃ­ Apple UI/UX issues
