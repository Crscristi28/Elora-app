# ğŸ¤– Claude Agent Architecture - Omnia Tool System

**Status:** ğŸ“‹ Planning & Research Complete
**Datum:** 2025-01-17
**CÃ­l:** JednoduchÃ½, cost-efektivnÃ­ systÃ©m pro orchestraci tools pomocÃ­ Claude Sonnet 4.5

---

## ğŸ“Š Architektura - 3-Tier SystÃ©m

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER QUERY                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš€ GEMINI FLASH (Main Model) - 90% Äasu                    â”‚
â”‚  â€¢ BÄ›Å¾nÃ½ chat                                                â”‚
â”‚  â€¢ Google Search grounding                                   â”‚
â”‚  â€¢ Cost: ~$0.50 per 900 queries                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ FLASH LITE (Intent Detector) - Ultra cheap              â”‚
â”‚  â€¢ Detekuje "query" vs "request"                            â”‚
â”‚  â€¢ Cost: $0.075/1M tokens                                   â”‚
â”‚  â€¢ Rozhoduje: "Needs tools?" â†’ Wake Claude                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ (Only if tools needed - 10% Äasu)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§  CLAUDE SONNET 4.5 (Tool Agent) - SpÃ­ 90% Äasu          â”‚
â”‚  â€¢ generate_pdf (PDF creation)                              â”‚
â”‚  â€¢ generate_image (Imagen API)                              â”‚
â”‚  â€¢ ParalelnÃ­ volÃ¡nÃ­ vÅ¡ech tools najednou                    â”‚
â”‚  â€¢ Prompt caching: 90% cost savings                         â”‚
â”‚  â€¢ Cost: $3-15/1M tokens (kdyÅ¾ je aktivnÃ­)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   OMNIA UI + RESULTS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ProÄ tento design?

### âŒ PÅ¯vodnÃ­ plÃ¡n (pÅ™Ã­liÅ¡ sloÅ¾itÃ½):
- Gemini agent pro kaÅ¾dÃ½ tool (PDF Agent, Image Agent, Search Agent...)
- Intent Classifier pro routing mezi agenty
- Vertex AI limitation: "Multiple tools are supported only when they are all search tools"
- 10+ komponent k ÃºdrÅ¾bÄ›

### âœ… NovÃ½ plÃ¡n (jednoduchÃ½):
- **1 Claude agent** pro vÅ¡echny tools
- **1 Intent detector** (Flash Lite) pro rozhodovÃ¡nÃ­
- **Gemini Flash** zÅ¯stÃ¡vÃ¡ hlavnÃ­ model
- Claude mÅ¯Å¾e volat tools **paralelnÄ›** bez omezenÃ­
- Claude "spÃ­" 90% Äasu â†’ levnÄ›jÅ¡Ã­

---

## ğŸ” Research Findings - Claude Sonnet 4.5

### Model Info
```javascript
model: "claude-sonnet-4-5-20250929" // âœ… September 2025 release
```

### KlÃ­ÄovÃ© Schopnosti

#### 1. **Parallel Tool Calling** ğŸ¯
- MÅ¯Å¾e volat **vÃ­ce tools souÄasnÄ›** v jednÃ© odpovÄ›di
- Å½Ã¡dnÃ© omezenÃ­ na typy (custom + server tools mix)
- Gemini/Vertex AI tohle neumÃ­!

```javascript
// PÅ™Ã­klad: Claude mÅ¯Å¾e v jednÃ© odpovÄ›di:
tools: [
  { type: "user", name: "generate_pdf" },      // Custom tool
  { type: "user", name: "generate_image" },    // Custom tool
  { type: "web_search_20250305", name: "web_search" } // Server tool
]
// âœ… VÅ¡echny 3 mÅ¯Å¾e zavolat paralelnÄ›!
```

#### 2. **Extended Context** ğŸ“š
- **200K context window** (massive!)
- **64K output tokens** (vs. starÃ½ 2K limit)
- IdeÃ¡lnÃ­ pro komplexnÃ­ tool orchestraci

#### 3. **Prompt Caching** ğŸ’°
**NejvÄ›tÅ¡Ã­ cost saver!**

```javascript
// System prompt caching
system: [
  {
    type: "text",
    text: agentSystemPrompt,
    cache_control: { type: "ephemeral" } // âš¡ 90% savings!
  }
]

// Tool definitions caching
tools: [
  {
    type: "user",
    name: "generate_pdf",
    description: "...",
    input_schema: { /* ... */ },
    cache_control: { type: "ephemeral" } // âš¡ Cache this too!
  }
]
```

**Cost breakdown:**
- Cache write: +25% nad base input ($3/M â†’ $3.75/M) - jednorÃ¡zovÄ›
- Cache read: -90% od base input ($3/M â†’ $0.30/M) - kaÅ¾dÃ½ dalÅ¡Ã­ call!
- Cache lifetime: 5 minut (nebo 1 hodina pro >10K tokens)

**Savings example:**
- Bez cachingu: $0.060 per call
- S cachingem: $0.041 per call
- **Ãšspora: 32% na kaÅ¾dÃ©m volÃ¡nÃ­!**

#### 4. **Context Management API** ğŸ“Š
- Auto-tracking token usage
- PÅ™edchÃ¡zÃ­ "premature task abandonment"
- Claude vÃ­ kdy mÃ¡ dost prostoru pro dokonÄenÃ­

#### 5. **Extended Thinking (Beta)** ğŸ¤”
```javascript
headers: {
  'anthropic-thinking': 'interleaved-thinking-2025-05-14'
}
// Internal reasoning pÅ™ed odpovÄ›dÃ­
// LepÅ¡Ã­ vÃ½sledky pro komplexnÃ­ tool orchestraci
```

---

## ğŸ’° Cost Analysis

### Current Pricing (Claude Sonnet 4.5)
| Component | Input | Output | Note |
|-----------|--------|---------|------|
| Base cost | $3/1M | $15/1M | Standard |
| Cache write | $3.75/1M | - | +25% (once) |
| Cache read | $0.30/1M | - | -90% (repeated) |
| Extended thinking | $6/1M | $30/1M | 2x cost |

### Gemini Flash (Main Model)
| Model | Cost | Usage |
|-------|------|-------|
| Flash | ~$0.50/900 queries | 90% Äasu |
| Flash Lite | $0.075/1M tokens | Intent detection |

### Projected Monthly Cost (100 msg/day)

**Bez Claude Agent:**
- Gemini Flash only: ~$15-20/month âœ…

**S Claude Agent (10% aktivace):**
```
Gemini Flash: $15-20/month (90% queries)
Intent Detector: ~$1/month (Flash Lite)
Claude Agent: ~$70/month (10% aktivace s cachingem)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total: ~$86-91/month
```

**User mÃ¡ $150 kredit:**
- VydrÅ¾Ã­: ~1.5-2 mÄ›sÃ­ce testovÃ¡nÃ­ âœ…
- Pokud funguje: Cost optimization dÃ¡l (menÅ¡Ã­ aktivace rate)

---

## ğŸ› ï¸ Implementation Plan

### Phase 1: Create Claude Agent Backend
**Soubor:** `/api/claude-agent.js` (novÃ½)

```javascript
export default async function handler(req, res) {
  const { messages, tools_needed } = req.body;

  const claudeRequest = {
    model: "claude-sonnet-4-5-20250929", // âœ… Latest
    max_tokens: 16000, // âœ… Much higher
    system: [
      {
        type: "text",
        text: getAgentSystemPrompt(),
        cache_control: { type: "ephemeral" } // âš¡ Cache!
      }
    ],
    messages: messages,
    tools: [
      {
        type: "user",
        name: "generate_pdf",
        description: "Generate PDF document from conversation",
        input_schema: {
          type: "object",
          properties: {
            conversationId: { type: "string" },
            fileName: { type: "string" }
          },
          required: ["conversationId", "fileName"]
        },
        cache_control: { type: "ephemeral" } // âš¡ Cache tools!
      },
      {
        type: "user",
        name: "generate_image",
        description: "Generate image using Imagen API",
        input_schema: {
          type: "object",
          properties: {
            prompt: { type: "string" },
            aspectRatio: { type: "string", enum: ["1:1", "16:9", "9:16"] },
            outputFormat: { type: "string", enum: ["jpeg", "png"] }
          },
          required: ["prompt"]
        },
        cache_control: { type: "ephemeral" }
      }
    ]
  };

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': process.env.CLAUDE_API_KEY,
      'anthropic-version': '2023-06-01',
      'anthropic-thinking': 'interleaved-thinking-2025-05-14' // Beta
    },
    body: JSON.stringify(claudeRequest)
  });

  // Handle tool_use responses
  // Execute tools (call /api/generate-pdf, /api/imagen)
  // Return results to Omnia
}
```

### Phase 2: Create Intent Classifier
**Soubor:** `/api/intent-classifier.js` (novÃ½)

```javascript
export default async function handler(req, res) {
  const { lastMessage } = req.body;

  // Flash Lite model ($0.075/1M tokens)
  const intentPrompt = `
You are an intent classifier. Analyze if user wants:
- "query" = just asking/chatting/search
- "request" = wants tool execution (PDF, image generation)

User message: "${lastMessage}"

Respond with JSON: {"intent": "query" or "request", "tools_needed": ["pdf", "image"]}
  `;

  // Call Gemini Flash Lite API
  const intent = await callFlashLite(intentPrompt);

  return res.json(intent);
}
```

### Phase 3: Integration do App.jsx
**Logika:**
```javascript
async function handleUserMessage(message) {
  // 1. PoÅ¡li Gemini Flash (main model)
  const geminiResponse = await geminiService.sendMessage(message);

  // 2. Intent detection
  const intent = await fetch('/api/intent-classifier', {
    method: 'POST',
    body: JSON.stringify({ lastMessage: message })
  });

  // 3. Wake Claude only if needed
  if (intent.intent === 'request') {
    console.log('ğŸ§  Waking Claude Agent...');
    const claudeResult = await fetch('/api/claude-agent', {
      method: 'POST',
      body: JSON.stringify({
        messages: conversationHistory,
        tools_needed: intent.tools_needed
      })
    });

    // 4. Execute tools that Claude called
    for (const toolCall of claudeResult.tool_uses) {
      if (toolCall.name === 'generate_pdf') {
        await executePDF(toolCall.input);
      }
      if (toolCall.name === 'generate_image') {
        await executeImagen(toolCall.input);
      }
    }
  }

  // 5. Return final response
  return geminiResponse;
}
```

### Phase 4: Agent System Prompt
**Soubor:** `/src/prompts/claude-agent.js` (novÃ½)

```javascript
export const getAgentSystemPrompt = () => {
  return `You are Omnia's Tool Agent. Your job is to orchestrate tool execution.

AVAILABLE TOOLS:
1. generate_pdf - Create PDF from conversation
2. generate_image - Generate images via Imagen API

RULES:
- Call tools in parallel when possible
- Analyze user request carefully
- Return structured tool_use responses
- Don't generate conversational text (that's main model's job)

You are TASK-FOCUSED, not personality-focused. Execute efficiently.`;
};
```

---

## ğŸ”„ Migration Strategy

### Co ZÅ®STÃVÃ stejnÃ©:
âœ… Gemini Flash jako hlavnÃ­ conversational model
âœ… Google Search grounding (zÅ¯stÃ¡vÃ¡ u Gemini)
âœ… `/src/prompts/omnia.js` - Omnia personality prompt
âœ… `/api/gemini.js` - Main backend
âœ… CelÃ½ frontend (UI, chat components)

### Co je NOVÃ‰:
ğŸ†• `/api/claude-agent.js` - Tool orchestration
ğŸ†• `/api/intent-classifier.js` - Intent detection
ğŸ†• `/src/prompts/claude-agent.js` - Agent prompt
ğŸ†• `/src/services/ai/claude-agent.service.js` - Frontend service

### Co se RUÅ Ã:
âŒ PlÃ¡n na multi-agent Gemini systÃ©m
âŒ OddÄ›lenÃ© agenty pro kaÅ¾dÃ½ tool
âŒ SloÅ¾itÃ¡ routing logika mezi agenty

---

## ğŸ§ª Testing Plan

### Test 1: Basic Tool Call
```
User: "Vygeneruj mi PDF z tÃ©to konverzace"

Expected flow:
1. Gemini Flash responds conversationally
2. Intent classifier detects "request" â†’ tools: ["pdf"]
3. Claude Agent wakes up
4. Claude calls generate_pdf tool
5. PDF is generated
6. Omnia shows success message
```

### Test 2: Parallel Tools
```
User: "VytvoÅ™ mi obrÃ¡zek lesa a uloÅ¾ konverzaci do PDF"

Expected flow:
1. Intent classifier detects "request" â†’ tools: ["image", "pdf"]
2. Claude Agent calls BOTH tools in parallel
3. Imagen generates image
4. PDF is generated
5. Both results shown to user
```

### Test 3: Cost Monitoring
```
- Track token usage per call
- Verify cache hits/misses
- Calculate actual cost vs projected
- Optimize if needed
```

---

## ğŸ“‹ Checklist

### Backend
- [ ] VytvoÅ™it `/api/claude-agent.js`
- [ ] VytvoÅ™it `/api/intent-classifier.js`
- [ ] Update environment variables (CLAUDE_API_KEY)
- [ ] Implementovat prompt caching
- [ ] Implementovat parallel tool execution handler
- [ ] Error handling a fallbacks

### Frontend
- [ ] VytvoÅ™it `/src/services/ai/claude-agent.service.js`
- [ ] VytvoÅ™it `/src/prompts/claude-agent.js`
- [ ] Integrace do App.jsx
- [ ] UI pro Claude agent status (optional)
- [ ] Loading states pro tool execution

### Testing
- [ ] Test basic tool call (PDF)
- [ ] Test basic tool call (Image)
- [ ] Test parallel tools (PDF + Image)
- [ ] Test cost tracking
- [ ] Test cache effectiveness
- [ ] Test fallback when Claude unavailable

### Optimization
- [ ] MÄ›Å™it token usage
- [ ] MÄ›Å™it cache hit rate
- [ ] Optimalizovat agent prompt pro menÅ¡Ã­ tokeny
- [ ] Nastavit rate limiting (pokud potÅ™eba)

---

## ğŸ¯ Success Criteria

**Phase 1 ÃºspÄ›Å¡nÃ¡ kdyÅ¾:**
âœ… Claude agent sprÃ¡vnÄ› volÃ¡ tools
âœ… Prompt caching funguje (90% savings viditelnÃ©)
âœ… Parallel tool execution funguje
âœ… Cost je pod $100/month pro 100 msg/day

**Phase 2 optimization kdyÅ¾:**
âœ… Intent classifier mÃ¡ >95% accuracy
âœ… Claude se aktivuje jen kdyÅ¾ nutnÃ© (false positives <5%)
âœ… Tool execution < 5s latency
âœ… User experience je seamless

---

## ğŸ’¡ Future Ideas

### MoÅ¾nÃ© rozÅ¡Ã­Å™enÃ­ pozdÄ›ji:
- **Tool expansion:** PÅ™idat dalÅ¡Ã­ tools (web scraping, calculations)
- **Multi-step reasoning:** Extended thinking mode for complex tasks
- **Cost optimization:** Machine learning pro lepÅ¡Ã­ intent detection
- **Fallbacks:** Gemini function calling pokud Claude unavailable
- **Monitoring:** Dashboard pro cost tracking a usage analytics

---

## ğŸ“ Notes

**User mÃ¡ dalÅ¡Ã­ plÃ¡n k diskuzi:** "mam mozna jeste jeden plan ale potrebuju poradit potom"

**AktuÃ¡lnÃ­ kredity:**
- $150 Anthropic API kredit
- VyprÅ¡Ã­ za 6 mÄ›sÃ­cÅ¯
- StaÄÃ­ na 1.5-2 mÄ›sÃ­ce intensivnÃ­ho testovÃ¡nÃ­

**DÅ¯leÅ¾itÃ©:**
- Google Search ZÅ®STÃVÃ u Gemini (cost-effective)
- Claude je JEN pro tool orchestration
- Personality je stÃ¡le v Gemini (Omnia prompt)
- Claude mÃ¡ task-focused prompt (ne personality)

---

**VytvoÅ™eno:** 2025-01-17
**Status:** ğŸ“‹ Ready for Implementation
**DalÅ¡Ã­ krok:** ÄŒekat na user's "jeste jeden plan" a pak zaÄÃ­t implementaci
